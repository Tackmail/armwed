<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>สุ่มผู้โชคดี</title>
<link rel="stylesheet" href="styles.css" />
<style>
:root{
	--bg:#fffbea; --accent:#d9a700; --muted:#8a7320; --text:#3b2b00;
}
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#fffdf3,#fff);color:var(--text);}
.container{max-width:820px;margin:28px auto;padding:22px;border-radius:14px;background:#fff;border:1px solid rgba(182,123,0,0.06);box-shadow:0 12px 36px rgba(182,123,0,0.06);}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;color:var(--accent)}
.controls{display:flex;gap:8px;align-items:center}
.btn{border-radius:10px;padding:10px 14px;border:none;background:linear-gradient(90deg,var(--accent),#f7c948);color:#fff;font-weight:700;cursor:pointer}
.muted{background:transparent;border:1px solid rgba(182,123,0,0.10);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
.canvas-wrap{display:flex;gap:18px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:18px;position:relative}
#wheelCanvas{width:420px;height:420px;border-radius:999px;background:conic-gradient(rgba(0,0,0,0.02),transparent)}
.pointer{
	width:0;height:0;
	border-left:14px solid transparent;
	border-right:14px solid transparent;
	border-top:22px solid var(--accent);
	position:absolute;
	left:50%;
	top:50%;
	transform-origin:50% 0;
	transform:translateX(-50%) translateY(180px) rotate(0deg);
	transition:transform 0.3s ease;
}
.center-spin{
	position:absolute;
	left:50%;
	top:50%;
	transform:translate(-50%,-50%);
	z-index:10;
	padding:20px;
	border-radius:999px;
	background:linear-gradient(180deg,#fff,#fffaf0);
	border:2px solid var(--accent);
	font-weight:700;
	color:var(--accent);
	cursor:pointer;
	transition:all .2s ease;
}
.center-spin:hover{
	background:var(--accent);
	color:#fff;
}
.info{margin-top:14px;text-align:center;color:var(--muted)}
.winner{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#fffaf0,#fff);border:1px solid rgba(182,123,0,0.06);box-shadow:0 8px 24px rgba(182,123,0,0.06)}
.small{font-size:13px;color:#6b5b86}

/* Image slider styles */
.prizes-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid rgba(182,123,0,0.1);
}
.slider-container {
    width: 100%;
    max-width: 820px; /* ให้ยาวเต็มคอนเทนเนอร์ */
    margin: 0 auto;
    overflow: hidden;
    border-radius: 12px;
    position: relative;
    height: 120px; /* ลดความสูงให้เป็นแถบผืนผ้า */
}
.slider {
    display: flex;
    transition: transform 0.4s ease-in-out; /* เลื่อนเร็วขึ้นเล็กน้อย */
    align-items: center;
    height: 100%;
}
.slide {
    min-width: 100%;
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.slide img {
    width: auto;
    height: 100%; /* ให้ภาพมีความสูงเต็มช่อง (120px) และรักษาสัดส่วน */
    object-fit: cover;
    border-radius: 6px;
}
.slide-caption {
    position: absolute;
    bottom: 6px;
    left: 8px;
    right: 8px;
    background: rgba(0,0,0,0.4);
    color: white;
    padding: 6px 8px;
    text-align: center;
    font-size: 12px;
    border-radius: 6px;
}
.slider-nav {
    position: absolute;
    bottom: 6px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
}
.slider-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.5);
    cursor: pointer;
    border: none;
}
.slider-dot.active {
    background: white;
}
.slider-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.25);
    border: none;
    padding: 6px;
    cursor: pointer;
    color: white;
    border-radius: 50%;
    backdrop-filter: blur(4px);
}
.slider-btn:hover {
    background: rgba(0,0,0,0.4);
}
.prev-btn { left: 8px; }
.next-btn { right: 8px; }

@media (max-width:520px){ #wheelCanvas{width:320px;height:320px} }
</style>
</head>
<body>
<div class="container">
	<div class="header">
		<h1>สุ่มผู้โชคดี</h1>
		<div class="controls">
			<button id="backBtn" class="muted">กลับ</button>
			<button id="reloadBtn" class="muted">รีเฟรชข้อมูล</button>
		</div>
	</div>

	<div class="canvas-wrap">
		<div class="pointer" aria-hidden="true"></div>
		<button id="spinBtn" class="center-spin">SPIN!</button>
		<canvas id="wheelCanvas" width="420" height="420" role="img" aria-label="Wheel of names"></canvas>
	</div>

	<div class="info small" id="status">Loading registrations...</div>
	<div id="winnerBox" class="winner" style="display:none;"></div>

	<!-- Prize Showcase -->
	<div class="prizes-section">
		<div class="slider-container">
			<div class="slider" id="prizeSlider"><!-- slides will be injected dynamically --></div>
			<button class="slider-btn prev-btn">&lt;</button>
			<button class="slider-btn next-btn">&gt;</button>
			<div class="slider-nav"></div>
		</div>
	</div>
</div>

<script>
function loadRegistrations(){
	try { return JSON.parse(localStorage.getItem('registrations') || '[]'); } catch(e){ return []; }
}

const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const cx = canvas.width/2, cy = canvas.height/2, radius = Math.min(cx,cy) - 8;
let segments = []; // {label, color}
let isSpinning = false;
let currentRotation = 0; // radians

function pickColor(i, total){
	const hue = (i * (360/total)) % 360;
	return `hsl(${hue} 70% 60% / 1)`;
}

function drawWheel(){
	ctx.clearRect(0,0,canvas.width,canvas.height);
	const total = segments.length;
	if (total === 0) {
		ctx.fillStyle = '#fff8dc';
		ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.fill();
		ctx.fillStyle = '#6b5b86';
		ctx.font = '16px Inter, Arial'; ctx.textAlign='center'; ctx.fillText('ไม่มีข้อมูลผู้สมัคร',cx,cy);
		return;
	}
	const anglePer = (Math.PI*2)/total;
	for(let i=0;i<total;i++){
		const start = currentRotation + i*anglePer;
		const end = start + anglePer;
		// slice
		ctx.beginPath();
		ctx.moveTo(cx,cy);
		ctx.arc(cx,cy,radius,start,end);
		ctx.closePath();
		ctx.fillStyle = segments[i].color;
		ctx.fill();
		// inner label
		ctx.save();
		ctx.translate(cx,cy);
		ctx.rotate(start + anglePer/2);
		ctx.textAlign = "right";
		ctx.fillStyle = "rgba(0,0,0,0.8)";
		ctx.font = 'bold 14px Inter, Arial';
		ctx.fillText(truncate(segments[i].label,22), radius - 12, 6);
		ctx.restore();
	}
	// center disc
	ctx.beginPath(); ctx.arc(cx,cy,46,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
	ctx.beginPath(); ctx.arc(cx,cy,44,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.04)'; ctx.fill();
}

function truncate(s,n){ return s.length>n ? s.slice(0,n-1)+'…' : s; }

function buildSegments(){
    const regs = loadRegistrations();
    // สร้างเซกเมนต์ตามจำนวน piece
    segments = [];
    regs.forEach((r,i) => {
        // เพิ่มเซกเมนต์ตามจำนวน piece
        for(let q = 0; q < r.qty; q++) {
            segments.push({
                label: `${r.name} (${q+1}/${r.qty})`,
                color: pickColor(i, Math.max(1, regs.length)),
                originalIndex: i  // เก็บ index ต้นฉบับไว้อ้างอิง
            });
        }
    });
    
    // แสดงข้อมูลโอกาสชนะ
    const totalPieces = segments.length;
    const playerStats = regs.map(r => ({
        name: r.name,
        pieces: r.qty,
        chance: ((r.qty/totalPieces)*100).toFixed(1)
    }));
    
    document.getElementById('status').innerHTML = 
        `ผู้สมัครทั้งหมด ${regs.length} คน | จำนวนโอกาสทั้งหมด ${totalPieces} ช่อง<br>` +
        playerStats.map(p => 
            `${p.name}: ${p.pieces} piece (${p.chance}% โอกาสชนะ)`
        ).join('<br>');
    
    drawWheel();
}

function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

function spin(){
	if(isSpinning) return;
	const total = segments.length;
	if (total === 0) { alert('ไม่มีผู้สมัครให้สุ่ม'); return; }
	isSpinning = true;
	document.getElementById('spinBtn').disabled = true;
	document.getElementById('status').textContent = 'กำลังสุ่ม...';
	// random target: full rotations + random sector offset
	const spins = 4 + Math.floor(Math.random()*3); // 4..6 rotations
	const rnd = Math.random();
	const targetIndex = Math.floor(rnd * total);
	const anglePer = (Math.PI*2)/total;
	// compute target rotation so that targetIndex aligns with pointer at top (pointer at -90deg)
	const targetRotation = (Math.PI*2 * spins) + ( (Math.PI*2) - (targetIndex * anglePer) - anglePer/2 );
	const start = currentRotation;
	const duration = 4200 + Math.floor(Math.random()*1200);
	const startTime = performance.now();

	function frame(now){
		const t = Math.min(1, (now - startTime)/duration);
		const eased = easeOutCubic(t);
		currentRotation = start + (targetRotation - start) * eased;
		drawWheel();
		if (t < 1) {
			requestAnimationFrame(frame);
		} else {
			// finish
			isSpinning = false;
			document.getElementById('spinBtn').disabled = false;
			// normalize rotation
			currentRotation = currentRotation % (Math.PI*2);
			// calculate winner index
			const normalized = (Math.PI*2 - (currentRotation - anglePer/2)) % (Math.PI*2);
			let winner = Math.floor(normalized / anglePer) % total;
			if (winner < 0) winner += total;
			showWinner(winner);
		}
	}
	requestAnimationFrame(frame);
}

function showWinner(idx){
	const regs = loadRegistrations();
	// ใช้ originalIndex เพื่อหาผู้ชนะจริง
	const segment = segments[idx];
	const r = regs[segment.originalIndex];
	
	const box = document.getElementById('winnerBox');
	box.style.display = 'block';
	box.innerHTML = `
		<strong>ผู้ชนะ:</strong> ${r?.name || 'ไม่ทราบ'}
		<div class="small">
		 ติดต่อ: ${r?.phone || '-'}<br>
		 จำนวนที่ลงทะเบียน: ${r?.qty || 0} piece
		</div>
	`;
	document.getElementById('status').textContent = `ผู้ชนะ: ${r?.name || '-'}`;
	
	// Rotate pointer to winner
	const total = segments.length;
	const anglePer = 360/total;
	const pointer = document.querySelector('.pointer');
	pointer.style.transform = `translateX(-50%) translateY(180px) rotate(${(idx * anglePer) + (anglePer/2)}deg)`;
}

document.getElementById('spinBtn').addEventListener('click', spin);
document.getElementById('reloadBtn').addEventListener('click', () => { buildSegments(); document.getElementById('winnerBox').style.display='none'; });
document.getElementById('backBtn').addEventListener('click', () => { location.href = './index.html'; });

// initial
buildSegments();

// Replace the static slider-init block with a dynamic loader
(async function initPrizesSlider(){
    const prizeSlider = document.getElementById('prizeSlider');
    const nav = document.querySelector('.slider-nav');
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');

    // try multiple filename patterns and stop after several consecutive misses
    const exts = ['jpg','png','webp','jpeg'];
    const maxIndex = 40;
    const maxConsecutiveMiss = 6;
    const found = [];
    let consecutiveMiss = 0;

    for(let i=1;i<=maxIndex && consecutiveMiss < maxConsecutiveMiss;i++){
        let hit = false;
        for(const ext of exts){
            const path = `prizes/prize${i}.${ext}`;
            try{
                // HEAD is lighter; some servers may not support it — fallback to GET if needed
                const res = await fetch(path, { method: 'HEAD' });
                if(res.ok){
                    found.push({src: path, caption: `รางวัล ${i}`});
                    hit = true;
                    break;
                }
            }catch(e){
                // ignore and try other extensions
            }
        }
        if(hit) consecutiveMiss = 0; else consecutiveMiss++;
    }

    // If nothing found, keep a placeholder slide (do not modify server files)
    if(found.length === 0){
        prizeSlider.innerHTML = `<div class="slide"><div class="slide-caption">ไม่มีรูปในโฟลเดอร์ prizes</div></div>`;
    } else {
        prizeSlider.innerHTML = '';
        found.forEach(f => {
            const slide = document.createElement('div');
            slide.className = 'slide';
            slide.innerHTML = `<img src="${f.src}" alt="${f.caption}"><div class="slide-caption">${f.caption}</div>`;
            prizeSlider.appendChild(slide);
        });
    }

    // Initialize slider controls (re-usable code similar to original)
    const slider = document.querySelector('.slider');
    let slides = document.querySelectorAll('.slide');
    let currentSlide = 0;

    // create dots
    nav.innerHTML = '';
    slides.forEach((_, i) => {
        const dot = document.createElement('button');
        dot.className = 'slider-dot';
        if(i===0) dot.classList.add('active');
        dot.addEventListener('click', () => goToSlide(i));
        nav.appendChild(dot);
    });

    function updateSlider(){
        slider.style.transform = `translateX(-${currentSlide * 100}%)`;
        document.querySelectorAll('.slider-dot').forEach((dot, i) => {
            dot.classList.toggle('active', i === currentSlide);
        });
    }

    function goToSlide(n){
        slides = document.querySelectorAll('.slide'); // refresh in case of dynamic changes
        currentSlide = n % slides.length;
        updateSlider();
    }

    function nextSlide(){
        slides = document.querySelectorAll('.slide');
        currentSlide = (currentSlide + 1) % slides.length;
        updateSlider();
    }

    function prevSlide(){
        slides = document.querySelectorAll('.slide');
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        updateSlider();
    }

    prevBtn.addEventListener('click', prevSlide);
    nextBtn.addEventListener('click', nextSlide);

    // auto-advance if there is more than one slide
    if(document.querySelectorAll('.slide').length > 1){
        // เลื่อนอัตโนมัติ ภาพละ 2000ms (2 วินาที)
        setInterval(nextSlide, 2000);
    }
})();
</script>
</body>
</html>
